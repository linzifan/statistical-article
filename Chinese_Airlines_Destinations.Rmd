---
title: "Chinese Airlines Destinations"
author: "Zifan Lin"
date: "April 9, 2015"
output: html_document
---

This idea is inspired by Matt Hartzell. In [his article](http://zhuanlan.zhihu.com/matthartzell/19997041#comment-74074628), he investigated the international connectivity among airports in China and U.S. Here I want to study another important component of civil aviation, airlines. I will compare the variety of Chinese Airlines Destinations, especially those international destinations. Let's start with the top 4 Chinese Airlines: Air China (CA), China Eastern Airlines (MU), China Southern Airlines (CZ), and Hainan Airlines (HU).

The small project is used to train my data analysis techniques in:

- Web spider (extract html element with `Python`)
- Data Manipulation (with `Python` or `R`)
- Data Summary and Description (with `R`)

Data are from Wikipedia. Most of them are updated as of January 2015.

#### Step 1
Create four `csv` file using `Python`. It is fortunate that these four wiki pages share the same format of tables of destinations. I'll record five attributes: City, Country, IATA, ICAO, and airport.

##### Further Improvment
1. For each airlines, service to some destinations has been *terminated* (with a different background color on wiki page). Here, I do not distinguish them.
2. China Southern Airlines includes some cargo-only destinations. Also reference indicators are recorded in airport attribute. I'll get rid of it when merge the data.
3. When I want to introduce more Chinese Airlines, some of them do not have the same format of tables.

**Python** code:
```{r test-python, eval=FALSE, engine='python'}
import requests
from bs4 import BeautifulSoup
import csv


url_dic = {"CA.csv":"http://en.wikipedia.org/wiki/Air_China_destinations",
           "MU.csv":"http://en.wikipedia.org/wiki/China_Eastern_Airlines_destinations",
           "CZ.csv":"http://en.wikipedia.org/wiki/China_Southern_Airlines_destinations",
           "HU.csv":"http://en.wikipedia.org/wiki/Hainan_Airlines_destinations"}

for item in url_dic.items():
    # get url
    url = item[1]
    page = requests.get(url)
    soup = BeautifulSoup(page.text)
    alltables = soup.findAll('table')
    # Identify the table of destinations
    # table has the structure: City | Province | Country | IATA | ICAO | Airport
    for i in range(len(alltables)):
        try:
            if alltables[i].findAll('th')[0].get_text() == "City":
                break
        except:
            continue
    # write csv
    with open(item[0],'wb') as f:
        filewriter = csv.writer(f, delimiter = ',')
        filewriter.writerow(["City", "Country", "IATA", "ICAO", "Airport"])
        for row in alltables[i].findAll('tr'):
            try:
                city = row.findAll('td')[0].get_text().splitlines()[0]
                country = row.findAll('td')[2].get_text()
                iata = row.findAll('td')[3].get_text()
                icao = row.findAll('td')[4].get_text()
                airport = row.findAll('td')[5].get_text()
                filewriter.writerow([city, country, iata, icao, airport])
            except:
                continue
    f.close()
    print item[0] + " has been created."

```


#### Step 2
Merge the data.

When I try to import the data into MySQL, I set IATA as the PRIMARY KEY. There are some duplicate entry for this primary key in MU and CZ datasets. The reason is that some cities have a new aiport to replace the old airport. IATA code was transfered to the new airport. I will remove those old airports manually.

Now we have four tables. I would like to merge them and create four attributes indicating whether the airline has this destination. The destination is identified by IATA code.

**MySQL** Code:
```{r, eval=FALSE}
DROP DATABASE IF EXISTS airlines;

CREATE DATABASE airlines;

USE airlines;

DROP TABLE IF EXISTS CA;
CREATE TABLE CA (
  City varchar(32) NOT NULL,
  Country varchar(64),
  IATA varchar(32),
  ICAO varchar(32),
  Airport varchar(64),
  PRIMARY KEY (IATA)
);
SELECT * FROM CA;


DROP TABLE IF EXISTS MU;
CREATE TABLE MU (
  City varchar(32) NOT NULL,
  Country varchar(64),
  IATA varchar(32),
  ICAO varchar(32),
  Airport varchar(64),
  PRIMARY KEY (IATA)
);
SELECT * FROM MU;


DROP TABLE IF EXISTS CZ;
CREATE TABLE CZ (
  City varchar(32) NOT NULL,
  Country varchar(64),
  IATA varchar(32),
  ICAO varchar(32),
  Airport varchar(64),
  PRIMARY KEY (IATA)
);
SELECT * FROM CZ;


DROP TABLE IF EXISTS HU;
CREATE TABLE HU (
  City varchar(32) NOT NULL,
  Country varchar(64),
  IATA varchar(32),
  ICAO varchar(32),
  Airport varchar(64),
  PRIMARY KEY (IATA)
);
SELECT * FROM HU;


--
-- MySQL do not support OUTER JOIN
-- Instead, we can use a LEFT JOIN UNION a RIGHT JOIN


SELECT CA.IATA as CA, MU.IATA as MU
FROM CA 
LEFT JOIN MU ON CA.IATA = MU.IATA
UNION
SELECT CA.IATA as CA, MU.IATA as MU
FROM CA 
RIGHT JOIN MU ON CA.IATA = MU.IATA;


# add a new column in each table indicating the operation airline
ALTER TABLE CA
ADD  CA varchar(8),
ADD  MU varchar(8),
ADD  CZ varchar(8),
ADD  HU varchar(8);
# unlock safe undate mode
SET SQL_SAFE_UPDATES = 0;
UPDATE CA
SET CA = 'yes';
select * from CA;

ALTER TABLE MU
ADD  CA varchar(8),
ADD  MU varchar(8),
ADD  CZ varchar(8),
ADD  HU varchar(8);
UPDATE MU
SET MU = 'yes';

ALTER TABLE CZ
ADD  CA varchar(8),
ADD  MU varchar(8),
ADD  CZ varchar(8),
ADD  HU varchar(8);
UPDATE CZ
SET CZ = 'yes';

ALTER TABLE HU
ADD  CA varchar(8),
ADD  MU varchar(8),
ADD  CZ varchar(8),
ADD  HU varchar(8);
UPDATE HU
SET HU = 'yes';



# Combine two table CA and MU first (outter join)
DROP TABLE IF EXISTS allairline; 
CREATE TABLE allairline AS
SELECT CA.IATA, CA.CA, MU.MU FROM CA
LEFT JOIN MU 
ON CA.IATA = MU.IATA
UNION 
SELECT MU.IATA, CA.CA, MU.MU FROM CA
RIGHT JOIN MU 
ON CA.IATA = MU.IATA;
# Then add CZ
CREATE TABLE allairline2 AS
SELECT allairline.*, CZ.CZ FROM allairline
LEFT JOIN CZ
ON allairline.IATA = CZ.IATA
UNION
SELECT CZ.IATA, allairline.CA, allairline.MU, CZ.CZ FROM allairline
RIGHT JOIN CZ
ON allairline.IATA = CZ.IATA;
# Finally add HU
CREATE TABLE allairline3 AS
SELECT allairline2.*, HU.HU FROM allairline2
LEFT JOIN HU
ON allairline2.IATA = HU.IATA
UNION
SELECT HU.IATA, allairline2.CA, allairline2.MU, allairline2.CZ, HU.HU FROM allairline2
RIGHT JOIN HU
ON allairline2.IATA = HU.IATA;

select * from allairline3 order by IATA;
# So far we have a table 'allairline3' with all destinations

# ALL IATA + city + country
CREATE TABLE CityDic AS
SELECT IATA, City, Country FROM CA
UNION
SELECT IATA, City, Country FROM MU
UNION
SELECT IATA, City, Country FROM CZ
UNION
SELECT IATA, City, Country FROM HU
ORDER BY IATA;

# Next, add city and country
SELECT CityDic.City, CityDIc.Country, allairline3.*
FROM allairline3 LEFT JOIN CityDic ON allairline3.IATA = CityDic.IATA
ORDER BY City;
```

**R** Code:
```{r, eval=FALSE}
CA <- read.csv("CA.csv", header = T)
CA$CA <- "yes"
MU <- read.csv("MU.csv", header = T)
MU$MU <- "yes"
CZ <- read.csv("CZ.csv", header = T)
CZ$CZ <- "yes"
HU <- read.csv("HU.csv", header = T)
HU$HU <- "yes"
allairline <- merge(CA[, c(3,6)], MU[, c(3,6)], by = "IATA", all = TRUE)
allairline <- merge(allairline, CZ[, c(3,6)], by = "IATA", all = TRUE)
allairline <- merge(allairline, HU[, c(3,6)], by = "IATA", all = TRUE)
```

There are 329 unique IATA code, but SQL result shows 345 records. There are several duplicate records caused by different reasons: 1) different country name ("Korea" or "South Korea"), 2) different city name ("Saint Petersburg" or "St. Petersburg"). There are also two mistakes of incorrect IATA code (Ganzhou Airport should be KOW instead of KOU, Mandalay Airport should be MDL instead of MDY).


#### Step 3
**Summary**
```{r}
setwd("~/Documents/python/python_practice/airlines")
allairline <- read.csv("all_destinations_modified.csv", header = T)
barplot(sort(summary(allairline$Country), decreasing = TRUE)[1:5])
```
